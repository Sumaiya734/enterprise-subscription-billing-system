<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Confirm Button</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Test Confirm Button Functionality</h1>
        
        <button class="btn btn-warning confirm-user-btn" 
                data-invoice-id="123" 
                data-cp-id="456" 
                data-customer-name="Test Customer" 
                data-product-name="Test Product" 
                data-next-due="100.50"
                data-bs-toggle="modal" 
                data-bs-target="#confirmUserPaymentModal">
            <i class="fas fa-check"></i> Confirm
        </button>
    </div>

    <!-- Confirm User Payment Modal -->
    <div class="modal fade" id="confirmUserPaymentModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>Confirm User Payment
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>This will close the billing month for this customer</strong>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Customer</label>
                        <div class="p-2 bg-light rounded" id="confirm_customer_name">-</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Product</label>
                        <div class="p-2 bg-light rounded" id="confirm_product_name">-</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Remaining Amount to Carry Forward</label>
                        <div class="p-3 bg-warning bg-opacity-10 rounded text-center">
                            <h4 class="mb-0 text-warning" id="confirm_next_due">৳ 0.00</h4>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-warning" id="confirmUserPaymentBtn">
                        <i class="fas fa-check me-1"></i>Confirm & Carry Forward
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Store confirmation data globally
        let confirmPaymentData = {};

        // Toast function (simplified)
        function showToast(title, type, message) {
            console.log(`${type}: ${title} - ${message}`);
            alert(`${type.toUpperCase()}: ${title}\n${message}`);
        }

        // Function to execute the confirmation
        window.executeConfirmUserPayment = function() {
            console.log('=== EXECUTE CONFIRM USER PAYMENT STARTED ===');
            console.log('confirmPaymentData:', confirmPaymentData);
            
            const {
                invoiceId,
                cpId,
                customerName,
                productName,
                nextDue
            } = confirmPaymentData;

            console.log('Destructured data:', {
                invoiceId,
                cpId,
                customerName,
                productName,
                nextDue
            });

            if (!invoiceId || !cpId) {
                console.error('Missing required data:', { invoiceId, cpId });
                showToast('Error', 'Missing required data for confirmation', 'danger');
                return;
            }

            console.log('All required data present, proceeding...');

            // Show loading state on button
            const confirmBtn = document.getElementById('confirmUserPaymentBtn');
            console.log('Confirm button element:', confirmBtn);
            
            if (!confirmBtn) {
                console.error('Confirm button not found!');
                return;
            }
            
            const originalBtnHtml = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Processing...';
            confirmBtn.disabled = true;

            console.log('Simulating AJAX request...');

            // Simulate AJAX request
            setTimeout(() => {
                // Simulate success response
                const data = {
                    success: true,
                    message: 'User payment confirmed successfully!',
                    carried_forward_amount: parseFloat(nextDue),
                    invoice_status: 'confirmed',
                    next_month_url: '#',
                    next_cycle_subtotal: 0
                };

                console.log('Simulated AJAX response received:', data);
                
                if (data.success) {
                    // Close modal
                    const modalElement = document.getElementById('confirmUserPaymentModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }

                    // Show success message
                    showToast('Payment Confirmed Successfully!', 'success', `Customer: ${customerName}\nProduct: ${productName}\nCarried Forward: ৳${parseFloat(nextDue).toFixed(2)}`);

                    // Update button UI
                    setTimeout(() => {
                        const originalButton = document.querySelector('.confirm-user-btn');
                        if (originalButton) {
                            // Replace with View and Confirmed buttons
                            const actionCell = originalButton.parentNode;
                            actionCell.innerHTML = '';

                            // Add View button
                            const viewButton = document.createElement('button');
                            viewButton.className = 'btn btn-outline-info btn-sm mb-1';
                            viewButton.innerHTML = '<i class="fas fa-eye"></i> View';
                            actionCell.appendChild(viewButton);

                            // Add Confirmed button (gray, disabled)
                            const confirmedButton = document.createElement('button');
                            confirmedButton.className = 'btn btn-secondary btn-sm';
                            confirmedButton.disabled = true;
                            confirmedButton.innerHTML = '<i class="fas fa-check-circle"></i> Confirmed';
                            actionCell.appendChild(confirmedButton);
                        }
                    }, 300);
                } else {
                    showToast('Error', data.message || 'Failed to confirm user payment', 'danger');
                    // Restore button
                    confirmBtn.innerHTML = originalBtnHtml;
                    confirmBtn.disabled = false;
                }
            }, 2000);
        };

        // Handle confirm user button clicks - populate modal when shown
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Setting up event listeners');
            
            // Test: Add click listeners to all confirm buttons
            const confirmButtons = document.querySelectorAll('.confirm-user-btn');
            console.log('Found confirm buttons:', confirmButtons.length);
            
            confirmButtons.forEach((button, index) => {
                console.log(`Button ${index}:`, button);
                button.addEventListener('click', function(e) {
                    console.log('Confirm button clicked!', this);
                    console.log('Button data attributes:', {
                        invoiceId: this.getAttribute('data-invoice-id'),
                        cpId: this.getAttribute('data-cp-id'),
                        customerName: this.getAttribute('data-customer-name'),
                        productName: this.getAttribute('data-product-name'),
                        nextDue: this.getAttribute('data-next-due')
                    });
                });
            });
            
            const confirmUserPaymentModal = document.getElementById('confirmUserPaymentModal');
            if (confirmUserPaymentModal) {
                // Add event listener for the confirm button
                const confirmBtn = document.getElementById('confirmUserPaymentBtn');
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Confirm button clicked via event listener');
                        executeConfirmUserPayment();
                    });
                }
                
                confirmUserPaymentModal.addEventListener('show.bs.modal', function(event) {
                    console.log('Modal show event triggered');
                    const button = event.relatedTarget;
                    console.log('Related target button:', button);

                    if (button && button.classList.contains('confirm-user-btn')) {
                        console.log('Button has confirm-user-btn class');
                        const invoiceId = button.getAttribute('data-invoice-id');
                        const cpId = button.getAttribute('data-cp-id');
                        const customerName = button.getAttribute('data-customer-name');
                        const productName = button.getAttribute('data-product-name');
                        const nextDue = button.getAttribute('data-next-due');

                        console.log('Button attributes:', {
                            invoiceId,
                            cpId,
                            customerName,
                            productName,
                            nextDue
                        });

                        // Store data for later use
                        confirmPaymentData = {
                            invoiceId: invoiceId,
                            cpId: cpId,
                            customerName: customerName,
                            productName: productName,
                            nextDue: nextDue
                        };

                        console.log('confirmPaymentData set to:', confirmPaymentData);

                        // Update modal content
                        const confirmCustomerName = document.getElementById('confirm_customer_name');
                        const confirmProductName = document.getElementById('confirm_product_name');
                        const confirmNextDue = document.getElementById('confirm_next_due');

                        if (confirmCustomerName) confirmCustomerName.textContent = customerName;
                        if (confirmProductName) confirmProductName.textContent = productName;
                        if (confirmNextDue) confirmNextDue.textContent = `৳ ${(parseFloat(nextDue) || 0).toFixed(2)}`;
                    }
                });

                // Reset modal on close
                confirmUserPaymentModal.addEventListener('hidden.bs.modal', function() {
                    const confirmBtn = document.getElementById('confirmUserPaymentBtn');
                    if (confirmBtn) {
                        confirmBtn.innerHTML = '<i class="fas fa-check me-1"></i>Confirm & Carry Forward';
                        confirmBtn.disabled = false;
                    }
                    confirmPaymentData = {};
                });
            }
        });
    </script>
</body>
</html>
